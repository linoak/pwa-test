<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待辦事項清單 - 完整PWA版</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA 圖示 -->
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icons/icon-16x16.png">
    <link rel="apple-touch-icon" href="./icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-180x180.png">
</head>
<body>
    <div class="container">
        <header>
            <h1>📝 待辦事項清單</h1>
            <button id="installPWA" class="install-pwa-btn" style="display: none;">📱 安裝APP</button>
        </header>

        <!-- PWA 安裝提示區域 -->
        <div id="pwaInstallBanner" class="pwa-install-banner" style="display: none;">
            <div class="banner-content">
                <span>📱 將此APP安裝到手機主畫面，享受更好的使用體驗！</span>
                <button id="bannerInstallBtn" class="banner-install-btn">安裝</button>
                <button id="bannerDismissBtn" class="banner-dismiss-btn">稍後</button>
            </div>
        </div>

        <!-- 新增待辦事項表單 -->
        <div class="add-form">
            <div class="input-group">
                <input type="text" id="todoInput" placeholder="輸入待辦事項... (最多100則)" maxlength="100">
                <input type="date" id="todoDate" value="">
                <div class="color-picker">
                    <label for="todoColor">選擇顏色:</label>
                    <select id="todoColor">
                        <option value="#000000">黑色</option>
                        <option value="#FF0000">紅色</option>
                        <option value="#00FF00">綠色</option>
                        <option value="#0000FF">藍色</option>
                        <option value="#FFA500">橙色</option>
                        <option value="#800080">紫色</option>
                        <option value="#FFC0CB">粉色</option>
                        <option value="#A52A2A">棕色</option>
                    </select>
                </div>
            </div>
            <button id="addBtn" class="add-btn">新增</button>
            <div class="todo-limit-info">
                <span id="todoLimitInfo">還可新增 100 則記事</span>
            </div>
        </div>

        <!-- 分類標籤 -->
        <div class="tabs">
            <button class="tab-btn active" data-filter="today">今天</button>
            <button class="tab-btn" data-filter="week">本週</button>
            <button class="tab-btn" data-filter="all">全部</button>
            <button class="tab-btn" data-filter="overdue">過期</button>
        </div>

        <!-- 待辦事項列表 -->
        <div class="todo-list" id="todoList">
            <!-- 待辦事項將在這裡動態生成 -->
        </div>

        <!-- 統計資訊 -->
        <div class="stats">
            <div class="stat-item">
                <span class="stat-number" id="totalCount">0/100</span>
                <span class="stat-label">總計</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="completedCount">0</span>
                <span class="stat-label">已完成</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="pendingCount">0</span>
                <span class="stat-label">待完成</span>
            </div>
        </div>
        
        <!-- 記事數量進度條 -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0% (0/100)</div>
        </div>
    </div>

    <!-- 編輯待辦事項的模態框 -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>編輯待辦事項</h2>
            <div class="edit-form">
                <input type="text" id="editInput" placeholder="編輯待辦事項... (最多100字)" maxlength="100">
                <input type="date" id="editDate">
                <div class="color-picker">
                    <label for="editColor">選擇顏色:</label>
                    <select id="editColor">
                        <option value="#000000">黑色</option>
                        <option value="#FF0000">紅色</option>
                        <option value="#00FF00">綠色</option>
                        <option value="#0000FF">藍色</option>
                        <option value="#FFA500">橙色</option>
                        <option value="#800080">紫色</option>
                        <option value="#FFC0CB">粉色</option>
                        <option value="#A52A2A">棕色</option>
                    </select>
                </div>
                <div class="edit-buttons">
                    <button id="saveEditBtn" class="save-btn">儲存</button>
                    <button id="cancelEditBtn" class="cancel-btn">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 完整的TodoApp類別
        class TodoApp {
            constructor() {
                try {
                    const storedTodos = localStorage.getItem('todos');
                    if (storedTodos) {
                        this.todos = JSON.parse(storedTodos);
                    } else {
                        this.todos = [];
                    }
                } catch (error) {
                    console.error('讀取localStorage時發生錯誤:', error);
                    this.todos = [];
                }
                
                this.currentFilter = 'today';
                this.editingId = null;
                this.deferredPrompt = null;
                this.isOnline = navigator.onLine;
                
                this.init();
                this.setupPWA();
            }

            init() {
                this.setupEventListeners();
                this.setDefaultDate();
                this.renderTodos();
                this.updateStats();
                this.updateConnectionStatus();
            }

            setupPWA() {
                // 監聽安裝提示
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showInstallButton();
                    this.showInstallPrompt();
                });

                // 監聽安裝完成
                window.addEventListener('appinstalled', () => {
                    this.hideInstallPrompt();
                    this.hideInstallButton();
                    this.showNotification('APP已成功安裝到主畫面！', 'success');
                });

                // 監聽網路狀態
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateConnectionStatus();
                    this.hideOfflineNotice();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateConnectionStatus();
                    this.showOfflineNotice();
                });

                // 註冊Service Worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => {
                            console.log('ServiceWorker registered successfully');
                        })
                        .catch(error => {
                            console.log('ServiceWorker registration failed:', error);
                        });
                }

                // 檢查是否已經安裝
                this.checkIfInstalled();
                
                // 強制顯示安裝按鈕（用於GitHub Pages）
                setTimeout(() => {
                    this.showInstallButton();
                }, 3000);
            }

            showInstallButton() {
                const installBtn = document.getElementById('installPWA');
                if (installBtn) {
                    installBtn.style.display = 'block';
                    installBtn.style.animation = 'pulse 2s infinite';
                }
                
                // 同時顯示橫幅
                this.showInstallBanner();
            }

            hideInstallButton() {
                const installBtn = document.getElementById('installPWA');
                if (installBtn) {
                    installBtn.style.display = 'none';
                }
                
                // 同時隱藏橫幅
                this.hideInstallBanner();
            }

            checkIfInstalled() {
                // 檢查是否在獨立模式下運行（已安裝）
                if (window.matchMedia('(display-mode: standalone)').matches || 
                    window.navigator.standalone === true) {
                    this.hideInstallButton();
                } else {
                    // 如果沒有安裝，顯示安裝按鈕
                    setTimeout(() => {
                        this.showInstallButton();
                    }, 2000);
                }
            }

            setupEventListeners() {
                // 新增待辦事項
                document.getElementById('addBtn').addEventListener('click', () => this.addTodo());
                
                // 按Enter鍵新增
                document.getElementById('todoInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addTodo();
                });

                // 分類標籤切換
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.filter);
                    });
                });

                // 模態框關閉
                document.querySelector('.close').addEventListener('click', () => this.closeModal());
                document.getElementById('cancelEditBtn').addEventListener('click', () => this.closeModal());
                
                // 點擊模態框外部關閉
                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        this.closeModal();
                    }
                });

                // 儲存編輯
                document.getElementById('saveEditBtn').addEventListener('click', () => this.saveEdit());

                // PWA 安裝按鈕
                const installBtn = document.getElementById('installPWA');
                if (installBtn) {
                    installBtn.addEventListener('click', () => this.installApp());
                }

                // PWA 橫幅安裝按鈕
                const bannerInstallBtn = document.getElementById('bannerInstallBtn');
                if (bannerInstallBtn) {
                    bannerInstallBtn.addEventListener('click', () => this.installApp());
                }

                // PWA 橫幅關閉按鈕
                const bannerDismissBtn = document.getElementById('bannerDismissBtn');
                if (bannerDismissBtn) {
                    bannerDismissBtn.addEventListener('click', () => this.hideInstallBanner());
                }
            }

            setDefaultDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('todoDate').value = today;
            }

            addTodo() {
                const input = document.getElementById('todoInput');
                const dateInput = document.getElementById('todoDate');
                const colorSelect = document.getElementById('todoColor');
                
                const text = input.value.trim();
                const date = dateInput.value;
                const color = colorSelect.value;
                
                if (!text || !date) {
                    alert('請輸入待辦事項和選擇日期！');
                    return;
                }

                // 檢查是否已達到100則記事限制
                if (this.todos.length >= 100) {
                    alert('已達到100則記事限制！請先刪除一些舊的記事。');
                    return;
                }

                const todo = {
                    id: Date.now(),
                    text: text,
                    date: date,
                    color: color,
                    completed: false,
                    createdAt: new Date().toISOString()
                };

                this.todos.push(todo);
                this.saveTodos();
                this.renderTodos();
                this.updateStats();
                
                // 清空輸入框
                input.value = '';
                input.focus();
                
                // 顯示成功訊息
                this.showNotification(`待辦事項已新增！(第${this.todos.length}/100則)`, 'success');
            }

            deleteTodo(id) {
                if (confirm('確定要刪除這個待辦事項嗎？')) {
                    this.todos = this.todos.filter(todo => todo.id !== id);
                    this.saveTodos();
                    this.renderTodos();
                    this.updateStats();
                    this.showNotification('待辦事項已刪除！', 'info');
                }
            }

            toggleComplete(id) {
                const todo = this.todos.find(t => t.id === id);
                if (todo) {
                    todo.completed = !todo.completed;
                    this.saveTodos();
                    this.renderTodos();
                    this.updateStats();
                    
                    const message = todo.completed ? '已完成！' : '已取消完成！';
                    this.showNotification(message, 'success');
                }
            }

            editTodo(id) {
                const todo = this.todos.find(t => t.id === id);
                if (todo) {
                    this.editingId = id;
                    document.getElementById('editInput').value = todo.text;
                    document.getElementById('editDate').value = todo.date;
                    document.getElementById('editColor').value = todo.color;
                    document.getElementById('editModal').style.display = 'block';
                }
            }

            saveEdit() {
                const input = document.getElementById('editInput');
                const dateInput = document.getElementById('editDate');
                const colorSelect = document.getElementById('editColor');
                
                const text = input.value.trim();
                const date = dateInput.value;
                const color = colorSelect.value;
                
                if (!text || !date) {
                    alert('請輸入待辦事項和選擇日期！');
                    return;
                }

                const todo = this.todos.find(t => t.id === this.editingId);
                if (todo) {
                    todo.text = text;
                    todo.date = date;
                    todo.color = color;
                    
                    this.saveTodos();
                    this.renderTodos();
                    this.updateStats();
                    this.closeModal();
                    this.showNotification('待辦事項已更新！', 'success');
                }
            }

            closeModal() {
                document.getElementById('editModal').style.display = 'none';
                this.editingId = null;
            }

            switchTab(filter) {
                this.currentFilter = filter;
                
                // 更新標籤狀態
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const targetBtn = document.querySelector(`[data-filter="${filter}"]`);
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }
                
                this.renderTodos();
            }

            getFilteredTodos() {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // 計算本週的開始和結束日期
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                weekStart.setHours(0, 0, 0, 0);
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                weekEnd.setHours(23, 59, 59, 999);
                
                switch (this.currentFilter) {
                    case 'today':
                        return this.todos.filter(todo => todo.date === todayStr);
                    case 'week':
                        return this.todos.filter(todo => {
                            const todoDate = new Date(todo.date);
                            todoDate.setHours(12, 0, 0, 0);
                            return todoDate >= weekStart && todoDate <= weekEnd;
                        });
                    case 'all':
                        return this.todos;
                    case 'overdue':
                        return this.todos.filter(todo => {
                            const todoDate = new Date(todo.date);
                            return todoDate < today && !todo.completed;
                        });
                    default:
                        return this.todos;
                }
            }

            renderTodos() {
                const todoList = document.getElementById('todoList');
                const filteredTodos = this.getFilteredTodos();
                
                if (filteredTodos.length === 0) {
                    todoList.innerHTML = `
                        <div class="empty-state">
                            <p>${this.getEmptyStateMessage()}</p>
                        </div>
                    `;
                    return;
                }

                // 按日期排序
                filteredTodos.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                const htmlContent = filteredTodos.map(todo => this.renderTodoItem(todo)).join('');
                todoList.innerHTML = htmlContent;
            }

            getEmptyStateMessage() {
                switch (this.currentFilter) {
                    case 'today':
                        return '今天沒有待辦事項';
                    case 'week':
                        return '本週沒有待辦事項';
                    case 'all':
                        return '沒有待辦事項';
                    case 'overdue':
                        return '沒有過期的待辦事項';
                    default:
                        return '沒有待辦事項';
                }
            }

            renderTodoItem(todo) {
                const date = new Date(todo.date);
                const formattedDate = `${date.getMonth() + 1}/${date.getDate()}`;
                
                return `
                    <div class="todo-item ${todo.completed ? 'completed' : ''}" data-id="${todo.id}">
                        <div class="todo-content">
                            <div class="todo-text" style="color: ${todo.color};">${todo.text}</div>
                            <div class="todo-date">${formattedDate}</div>
                        </div>
                        <div class="todo-actions">
                            <button class="complete-btn" onclick="app.toggleComplete(${todo.id})">
                                ${todo.completed ? '✓' : '○'}
                            </button>
                            <button class="edit-btn" onclick="app.editTodo(${todo.id})">✎</button>
                            <button class="delete-btn" onclick="app.deleteTodo(${todo.id})">🗑</button>
                        </div>
                    </div>
                `;
            }

            updateStats() {
                const total = this.todos.length;
                const completed = this.todos.filter(todo => todo.completed).length;
                const pending = total - completed;
                
                document.getElementById('totalCount').textContent = `${total}/100`;
                document.getElementById('completedCount').textContent = completed;
                document.getElementById('pendingCount').textContent = pending;
                
                this.updateProgressBar(total, 100);
                this.updateTodoLimitInfo(total, 100);
            }

            updateProgressBar(current, max) {
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                
                if (progressFill && progressText) {
                    const percentage = Math.min((current / max) * 100, 100);
                    progressFill.style.width = `${percentage}%`;
                    progressText.textContent = `${Math.round(percentage)}% (${current}/${max})`;
                }
            }

            updateTodoLimitInfo(current, max) {
                const limitInfo = document.getElementById('todoLimitInfo');
                if (limitInfo) {
                    const remaining = max - current;
                    if (remaining <= 0) {
                        limitInfo.textContent = '已達到記事上限！';
                        limitInfo.style.color = '#ff4444';
                    } else if (remaining <= 10) {
                        limitInfo.textContent = `還可新增 ${remaining} 則記事`;
                        limitInfo.style.color = '#ff8800';
                    } else {
                        limitInfo.textContent = `還可新增 ${remaining} 則記事`;
                        limitInfo.style.color = '#4CAF50';
                    }
                }
            }

            saveTodos() {
                try {
                    const todosJson = JSON.stringify(this.todos);
                    localStorage.setItem('todos', todosJson);
                } catch (error) {
                    console.error('儲存到localStorage時發生錯誤:', error);
                }
            }

            // PWA 相關方法
            showInstallPrompt() {
                // 檢查是否已經有安裝提示
                if (document.getElementById('installPrompt')) {
                    return;
                }

                // 創建安裝提示
                const installPrompt = document.createElement('div');
                installPrompt.id = 'installPrompt';
                installPrompt.className = 'install-prompt';
                installPrompt.innerHTML = `
                    <div class="install-content">
                        <p>📱 將此APP安裝到手機主畫面</p>
                        <button id="installBtn" class="install-btn">安裝</button>
                        <button id="dismissInstall" class="dismiss-btn">稍後</button>
                    </div>
                `;
                
                document.body.appendChild(installPrompt);
                
                // 綁定按鈕事件
                document.getElementById('installBtn').addEventListener('click', () => this.installApp());
                document.getElementById('dismissInstall').addEventListener('click', () => this.hideInstallPrompt());
                
                // 3秒後自動隱藏
                setTimeout(() => {
                    this.hideInstallPrompt();
                }, 10000);
            }

            hideInstallPrompt() {
                const installPrompt = document.getElementById('installPrompt');
                if (installPrompt) {
                    installPrompt.remove();
                }
            }

            async installApp() {
                if (this.deferredPrompt) {
                    this.deferredPrompt.prompt();
                    const { outcome } = await this.deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                        this.showNotification('APP安裝成功！', 'success');
                    } else {
                        console.log('User dismissed the install prompt');
                        this.showNotification('安裝已取消', 'info');
                    }
                    this.deferredPrompt = null;
                    this.hideInstallPrompt();
                } else {
                    // 如果沒有 deferredPrompt，顯示手動安裝說明
                    this.showManualInstallInstructions();
                }
            }

            showManualInstallInstructions() {
                const instructions = `
                    <div class="manual-install-modal">
                        <div class="manual-install-content">
                            <h3>📱 手動安裝說明</h3>
                            <div class="install-steps">
                                <h4>Android (Chrome):</h4>
                                <p>1. 點擊瀏覽器選單 (⋮)</p>
                                <p>2. 選擇「安裝應用程式」</p>
                                <p>3. 點擊「安裝」</p>
                                
                                <h4>iOS (Safari):</h4>
                                <p>1. 點擊分享按鈕 (□↑)</p>
                                <p>2. 選擇「加入主畫面」</p>
                                <p>3. 點擊「新增」</p>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" class="close-btn">關閉</button>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', instructions);
            }

            updateConnectionStatus() {
                // 可以添加網路狀態指示器
            }

            showOfflineNotice() {
                const offlineNotice = document.createElement('div');
                offlineNotice.id = 'offlineNotice';
                offlineNotice.className = 'offline-notice';
                offlineNotice.innerHTML = '<p>📶 您目前處於離線狀態，但APP仍可正常使用</p>';
                document.body.appendChild(offlineNotice);
            }

            hideOfflineNotice() {
                const offlineNotice = document.getElementById('offlineNotice');
                if (offlineNotice) {
                    offlineNotice.remove();
                }
            }

            showNotification(message, type = 'info') {
                // 移除現有的通知
                const existingNotification = document.querySelector('.notification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                // 自動移除通知
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        notification.remove();
                    }
                }, 3000);
            }
        }

        // 全域變數
        let app;

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', () => {
            app = new TodoApp();
        });

        // 觸控手勢支援
        let startX = 0;
        let startY = 0;

        document.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', (e) => {
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            
            const diffX = startX - endX;
            const diffY = startY - endY;
            
            // 水平滑動切換標籤
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                const tabs = ['today', 'week', 'all', 'overdue'];
                const currentIndex = tabs.indexOf(app.currentFilter);
                
                if (diffX > 0 && currentIndex < tabs.length - 1) {
                    // 向左滑動，下一個標籤
                    app.switchTab(tabs[currentIndex + 1]);
                } else if (diffX < 0 && currentIndex > 0) {
                    // 向右滑動，上一個標籤
                    app.switchTab(tabs[currentIndex - 1]);
                }
            }
        });

        // 鍵盤快捷鍵支援
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case '1':
                        e.preventDefault();
                        app.switchTab('today');
                        break;
                    case '2':
                        e.preventDefault();
                        app.switchTab('week');
                        break;
                    case '3':
                        e.preventDefault();
                        app.switchTab('all');
                        break;
                    case '4':
                        e.preventDefault();
                        app.switchTab('overdue');
                        break;
                }
            }
        });
    </script>
</body>
</html>
